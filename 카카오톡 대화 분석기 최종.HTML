<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MBTI Nìœ í˜• íë§ë°© ëŒ€í™” ë¹ˆë„ ë¶„ì„ ğŸŒ±ğŸ’¬</title>
  <style>
    body { font-family: 'Noto Sans KR', Arial, sans-serif; margin: 30px; }
    #dashboard {margin:15px 0 16px 0;}
    #dashSummary { font-size: 1.1em; color:#1b2933; margin-bottom:4px; display:flex; align-items:center; gap:18px;}
    .dash-sep {color:#bbb; font-weight:normal;}
    .dash-hr {border:0; border-top:1.3px solid #ccc; margin:8px 0 8px 0;}
    .highlight {color:#2063b0; font-weight:bold;}
    .label-light {color:#666;}
    .rankingline {font-size:1.04em; margin-bottom:2px;}
    #topArea { display:flex; align-items: center; gap:14px; margin-bottom: 2px;}
    #dateControls { margin-top: 20px; }
    #filterBox { margin: 24px 0 8px 0; }
    #optionsBox { margin: 14px 0 0 0; }
    #nickFilter { width: 50%; min-width: 240px; min-height: 80px; max-width:400px; }
    .desc { color: #888; font-size: 13px; }
    .row-in { background: #e7f1ff !important; color: #1858c9 !important; font-weight:bold; }
    .row-zero { background: #f2f2f2 !important; color: #aaa !important; }
    .legendbox {margin: 15px 0 7px 0; display:none; align-items: center;}
    .legendchip {display:inline-block;width:16px;height:16px;margin-right:6px;vertical-align:middle;border-radius:4px;}
    .inchip {background:#e7f1ff;border:1px solid #1858c9;}
    .zerochip {background:#f2f2f2;border:1px solid #aaa;}
    .legendtext {font-size: 14px; color:#444;}
    h2 { font-size: 1.8em; }
    th, td { text-align:center; }
    input[type="checkbox"] { transform:scale(1.2); margin-right: 6px;}
    label { margin-right:18px;}
    #captureBtn { 
      background: #607D8B; color: #fff; border:none; border-radius:7px;
      padding: 6px 15px; font-size: 15px; cursor:pointer; font-weight:500;
      transition: background 0.2s;
      vertical-align:middle;
      letter-spacing:0.5px;
      margin-bottom:1px;
    }
    #captureBtn:hover { background:#455A64; }
    #trendSummary, #summaryTop, #divider, #resultCount {display:none;}
    #checkboxBar { margin-bottom: 8px;}
    .lightgray { color:#666; }
  </style>
</head>
<body>
  <div id="captureArea">
    <h2>ğŸŒ±ğŸ’¬ MBTI Nìœ í˜• íë§ë°© ëŒ€í™” ë¹ˆë„ ë¶„ì„ ğŸ’šğŸ§ </h2>
    <div id="topArea">
      <input type="file" id="fileInput" accept=".txt">
      <button id="captureBtn" onclick="capturePage()">í˜ì´ì§€ ì´ë¯¸ì§€ë¡œ ì €ì¥ (PNG)</button>
    </div>
    <div id="dateControls" style="display:none;">
      <label for="startDate">ì‹œì‘ ë‚ ì§œ:</label>
      <input type="date" id="startDate">
      <label for="endDate">ì¢…ë£Œ ë‚ ì§œ:</label>
      <input type="date" id="endDate">
      <button onclick="updateChart()">ê¸°ê°„ ë¶„ì„</button>
    </div>
    <div id="filterBox" style="display:none;">
      <b>ë‹‰ë„¤ì„ í•„í„° <span style="font-weight:normal;color:#888;">(ìµœëŒ€ ê²€ìƒ‰ ì¸ì› 100ëª…)</span>:</b>
      <button style="margin-left:7px; font-size:13px; padding:4px 9px;" onclick="updateChart()">í•„í„° ì ìš©</button>
      <div style="height:5px"></div>
      <textarea id="nickFilter" placeholder="ì—¬ê¸°ì— ë‹‰ë„¤ì„ì„ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      <div class="desc">í•„í„° ë‹‰ë„¤ì„ì´ <b>íŒŒë€ìƒ‰</b>ì´ë©´ í•´ë‹¹ ê¸°ê°„ì— ëŒ€í™” ì°¸ì—¬, <b>íšŒìƒ‰</b>ì´ë©´ ë¯¸ì°¸ì—¬ì…ë‹ˆë‹¤.<br>
      ì•„ë¬´ê²ƒë„ ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì „ì²´ ë‹‰ë„¤ì„ì´ í‘œì‹œë©ë‹ˆë‹¤.<br>
      â€» ìŠ¤í˜ì´ìŠ¤(ê³µë°±)ë„ ë‹‰ë„¤ì„ ì¼ë¶€ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.</div>
    </div>
    <!-- âœ… ëŒ€ì‹œë³´ë“œ ìš”ì•½ ì¶”ê°€ -->
    <div id="dashboard" style="margin-bottom:10px; display:none;">
      <div id="dashSummary"></div>
      <div class="dash-hr"></div>
      <div class="rankingline" id="monthlyTop"></div>
      <div class="rankingline" id="hot7days"></div>
      <div class="dash-hr"></div>
    </div>
    <div id="optionsBox" style="display:none;">
      <div id="checkboxBar">
        <label><input type="checkbox" id="showFirst" checked onchange="updateChart()">ì²« ëŒ€í™” í¬í•¨</label>
        <label><input type="checkbox" id="showLast" checked onchange="updateChart()">ë§ˆì§€ë§‰ ëŒ€í™” í¬í•¨</label>
        <label><input type="checkbox" id="showDay" checked onchange="updateChart()">ì¶œëª° ìš”ì¼</label>
        <label><input type="checkbox" id="showHour" checked onchange="updateChart()">ì¶œëª° ì‹œê°„</label>
        <!-- ì£¼ìš”í‚¤ì›Œë“œ ì²´í¬ë°•ìŠ¤ ì‚­ì œ -->
      </div>
      <label><input type="checkbox" id="showIn" checked onchange="updateChart()">ì°¸ì—¬</label>
      <label><input type="checkbox" id="showOut" checked onchange="updateChart()">ë¯¸ì°¸ì—¬</label>
    </div>
    <div class="legendbox" id="legendBox">
      <span class="legendchip inchip"></span><span class="legendtext">ì°¸ì—¬</span> &nbsp; 
      <span class="legendchip zerochip"></span><span class="legendtext">ë¯¸ì°¸ì—¬</span>
    </div>
    <div id="result"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    let messages = [];
    let uniqueDates = [];

    // (ë¶ˆìš©ì–´ ë¦¬ìŠ¤íŠ¸/í•¨ìˆ˜ ë“± ê¸°ì¡´ ë™ì¼í•˜ê²Œ ìœ ì§€)
    // ...banWords, isBanWord í•¨ìˆ˜ ë“± ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”...

    function pad(n) { return n<10 ? '0'+n : n; }
    function isDateLike(text) { return /^\d{4}ë…„\s*\d{1,2}ì›”\s*\d{1,2}ì¼/.test(text.trim()); }
    function isTimeLike(text) { return /^(ì˜¤ì „|ì˜¤í›„)\s*\d{1,2}:\d{2}$/.test(text.trim()); }

    function parseKakaoTxt(text) {
      messages = [];
      let lines = text.split('\n');
      let currentDateStr = null;
      let datePattern = /^-+\s*(\d{4})ë…„\s*(\d{1,2})ì›”\s*(\d{1,2})ì¼/;
      let msgPattern = /^\[([^\[\]]+)\]\s+\[(ì˜¤ì „|ì˜¤í›„)\s*\d{1,2}:\d{2}\]\s*(.+)$/;
      let nicknamePattern = /^\[([^\[\]]+)\]\s+\[(ì˜¤ì „|ì˜¤í›„)\s*\d{1,2}:\d{2}\]/;
      for(let line of lines) {
        let dateMatch = line.match(datePattern);
        if(dateMatch) {
          currentDateStr = dateMatch[1] + '-' + pad(parseInt(dateMatch[2])) + '-' + pad(parseInt(dateMatch[3]));
          continue;
        }
        if(currentDateStr) {
          let msgMatch = line.match(msgPattern);
          if(msgMatch) {
            let user = msgMatch[1].trim();
            let time = msgMatch[2] + " " + line.match(/\[(ì˜¤ì „|ì˜¤í›„)\s*\d{1,2}:\d{2}\]/)[0].replace(/[\[\]]/g, "");
            let msg = msgMatch[3].trim();
            if (
              user.length > 0 &&
              !isDateLike(user) &&
              !isTimeLike(user)
            ) {
              messages.push({
                user: user,
                date: currentDateStr,
                time: time,
                msg: msg
              });
            }
          } else {
            let match = line.match(nicknamePattern);
            if(match) {
              let user = match[1].trim();
              let time = match[2] + " " + line.match(/\[(ì˜¤ì „|ì˜¤í›„)\s*\d{1,2}:\d{2}\]/)[0].replace(/[\[\]]/g, "");
              messages.push({
                user: user,
                date: currentDateStr,
                time: time,
                msg: ""
              });
            }
          }
        }
      }
      uniqueDates = Array.from(new Set(messages.map(x=>x.date))).sort();
    }

    function getNickFilterList() {
      let val = document.getElementById('nickFilter').value.trim();
      if(!val) return null;
      let arr = val.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      return arr.slice(0,100); // ìµœëŒ€ 100ëª…
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(evt) {
        parseKakaoTxt(evt.target.result);
        if(messages.length===0) {
          document.getElementById('result').innerHTML = "<b style='color:red'>ëŒ€í™” ë°ì´í„°ë¥¼ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ ì¹´ì¹´ì˜¤í†¡ txt íŒŒì¼ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.</b>";
          document.getElementById('dateControls').style.display = "none";
          document.getElementById('filterBox').style.display = "none";
          document.getElementById('optionsBox').style.display = "none";
          document.getElementById('legendBox').style.display = "none";
          document.getElementById('dashboard').style.display = "none";
          return;
        }
        let minDate = uniqueDates[0];
        let maxDate = uniqueDates[uniqueDates.length-1];
        document.getElementById('startDate').value = minDate;
        document.getElementById('endDate').value = maxDate;
        document.getElementById('startDate').min = minDate;
        document.getElementById('startDate').max = maxDate;
        document.getElementById('endDate').min = minDate;
        document.getElementById('endDate').max = maxDate;
        document.getElementById('dateControls').style.display = "";
        document.getElementById('filterBox').style.display = "";
        document.getElementById('optionsBox').style.display = "";
        document.getElementById('legendBox').style.display = "flex";
        document.getElementById('dashboard').style.display = "";
        updateChart();
      };
      reader.readAsText(file, "UTF-8");
    });

    function updateChart() {
      let start = document.getElementById('startDate').value;
      let end = document.getElementById('endDate').value;
      if (!start || !end) return;
      let st = new Date(start);
      let et = new Date(end);

      let showFirst = document.getElementById('showFirst').checked;
      let showLast = document.getElementById('showLast').checked;
      let showDay = document.getElementById('showDay').checked;
      let showHour = document.getElementById('showHour').checked;
      let showIn = document.getElementById('showIn') ? document.getElementById('showIn').checked : true;
      let showOut = document.getElementById('showOut') ? document.getElementById('showOut').checked : true;

      // ê¸°ê°„ë³„ë¡œ ë©”ì‹œì§€ ì¹´ìš´íŠ¸
      let filtered = messages.filter(x => {
        let d = new Date(x.date);
        return d >= st && d <= et;
      });

      // ê° userë³„ ëŒ€í™” ì‹œê° ìˆ˜ì§‘ + ë©”ì‹œì§€ ëª¨ìŒ
      let userMap = {}, firstMap = {}, lastMap = {},
          dayMap = {}, hourMap = {};
      for (let i = 0; i < filtered.length; ++i) {
        let m = filtered[i];
        if (!userMap[m.user]) {
          userMap[m.user] = 1;
          firstMap[m.user] = `${m.date} ${m.time}`;
          lastMap[m.user] = `${m.date} ${m.time}`;
        } else {
          userMap[m.user]++;
          lastMap[m.user] = `${m.date} ${m.time}`;
        }
        if (showDay) {
          let dt = new Date(m.date);
          let w = dt.getDay();
          if (!dayMap[m.user]) dayMap[m.user] = Array(7).fill(0);
          dayMap[m.user][w]++;
        }
        if (showHour) {
          let hour = getHour(m.time);
          if (!hourMap[m.user]) hourMap[m.user] = Array(24).fill(0);
          if (hour >= 0 && hour <= 23) hourMap[m.user][hour]++;
        }
      }
      // ì¶œëª° ìš”ì¼ ì´ë¦„
      const weekNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

      let filterList = getNickFilterList();
      let userArr = [];
      if(filterList) {
        let tmpArr = filterList.map(u => [
          u,
          userMap[u] || 0,
          firstMap[u] || "-",
          lastMap[u] || "-",
          getMaxDay(dayMap[u], weekNames, showDay),
          getMaxHour(hourMap[u], showHour)
        ]);
        let arr_participated = tmpArr.filter(([u, c]) => c > 0).sort((a, b) => b[1] - a[1]);
        let arr_not = tmpArr.filter(([u, c]) => c === 0);
        userArr = arr_participated.concat(arr_not);
      } else {
        userArr = Object.keys(userMap).map(u => [
          u, userMap[u], firstMap[u], lastMap[u],
          getMaxDay(dayMap[u], weekNames, showDay),
          getMaxHour(hourMap[u], showHour)
        ]);
        userArr.sort((a, b) => b[1] - a[1]);
      }

      // íŠ¸ë Œë“œ ìš”ì•½ ê³„ì‚°
      let dailyCountMap = {};
      for (let m of filtered) {
        if (!dailyCountMap[m.date]) dailyCountMap[m.date] = 0;
        dailyCountMap[m.date]++;
      }
      let dayList = Object.keys(dailyCountMap).sort();
      let counts = dayList.map(d=>dailyCountMap[d]);
      let max = Math.max(...counts);
      let min = Math.min(...counts);
      let maxDay = dayList[counts.indexOf(max)];
      let minDay = dayList[counts.indexOf(min)];
      let avg = counts.length ? (counts.reduce((a,b)=>a+b,0)/counts.length).toFixed(1) : 0;

      // ì „ ì›” ìƒìœ„ í™œë™ì
      let prevMonth = (function(){
        let d = new Date(start);
        d.setMonth(d.getMonth()-1);
        return d.toISOString().slice(0,7);
      })();
      let prevMonthStats = {};
      messages.forEach(m=>{
        if(m.date && m.date.startsWith(prevMonth)) {
          if(!prevMonthStats[m.user]) prevMonthStats[m.user]=1;
          else prevMonthStats[m.user]++;
        }
      });
      let prevTop = "-";
      let prevMax = 0;
      Object.entries(prevMonthStats).forEach(([u,c])=>{
        if(c>prevMax){prevMax=c;prevTop=u;}
      });

      // ìµœê·¼ 7ì¼ ê¸‰ìƒìŠ¹ ì¸ë¬¼
      let endD = new Date(end);
      let weekStart = new Date(endD.getTime() - 6*24*60*60*1000);
      let weekStr = weekStart.toISOString().slice(0,10);
      let currWeekStats = {};
      let prevWeekStats = {};
      messages.forEach(m=>{
        let md = m.date;
        if(md >= weekStr && md <= end) {
          if(!currWeekStats[m.user]) currWeekStats[m.user]=1;
          else currWeekStats[m.user]++;
        }
        let d = new Date(md);
        let wPrev = new Date(endD.getTime() - 13*24*60*60*1000);
        let wPrevEnd = new Date(endD.getTime() - 7*24*60*60*1000);
        if(d >= wPrev && d < wPrevEnd){
          if(!prevWeekStats[m.user]) prevWeekStats[m.user]=1;
          else prevWeekStats[m.user]++;
        }
      });
      let riseTop = "-";
      let riseDiff = -9999;
      Object.keys(currWeekStats).forEach(u=>{
        let diff = currWeekStats[u] - (prevWeekStats[u]||0);
        if(diff>riseDiff && currWeekStats[u]>0){riseDiff=diff;riseTop=u;}
      });

      // ëŒ€ì‹œë³´ë“œ ì¶œë ¥ (userArr ê¸¸ì´ ì²´í¬ í›„)
      let inCount = userArr.filter(([_,c])=>c>0).length;
      let totalUserCount = userArr.length;
      document.getElementById('dashboard').style.display = "";
      document.getElementById('dashSummary').innerHTML = 
        `<span><b>ì°¸ì—¬ììˆ˜</b> <span class="lightgray">${inCount}/${totalUserCount}</span></span>` +
        `<span class="dash-sep">|</span><span><b>ìµœë‹¤ëŒ€í™”ì¼</b> <span class="label-light">${maxDay||"-"}</span> <span class="highlight">${max||0}íšŒ</span></span>` +
        `<span class="dash-sep">|</span><span><b>ìµœì†ŒëŒ€í™”ì¼</b> <span class="label-light">${minDay||"-"}</span> <span class="highlight">${min||0}íšŒ</span></span>` +
        `<span class="dash-sep">|</span><span><b>í‰ê· ëŒ€í™”ëŸ‰</b> <span class="highlight">${avg}íšŒ/ì¼</span></span>`;
      document.getElementById('monthlyTop').innerHTML =
        `<span>ì „ ì›” ê°€ì¥ ë§ì´ í™œë™í•œ ì¸ë¬¼: <span class="highlight">${prevTop}</span></span>`;
      document.getElementById('hot7days').innerHTML =
        `<span>ìµœê·¼ 7ì¼ê°„ ê¸‰ìƒìŠ¹ ì¤‘ì¸ ì¸ë¬¼: <span class="highlight">${riseTop}</span></span>`;

      // í‘œ ë Œë”ë§
      let filteredUserArr = userArr.filter(([_,c])=>{
        if(c>0 && showIn) return true;
        if(c===0 && showOut) return true;
        return false;
      });
      let ths = `<th>ëŒ€í™”ëª…</th><th>ëŒ€í™” íšŸìˆ˜</th>`;
      if(showFirst) ths += `<th>ì²« ëŒ€í™”</th>`;
      if(showLast) ths += `<th>ë§ˆì§€ë§‰ ëŒ€í™”</th>`;
      if(showDay) ths += `<th>ì¶œëª° ìš”ì¼</th>`;
      if(showHour) ths += `<th>ì¶œëª° ì‹œê°„</th>`;

      let resultHtml = `<table id="mainTable" border="1" cellpadding="5" style="border-collapse:collapse;margin-top:10px;">
      <tr>${ths}</tr>`;
      filteredUserArr.forEach(([u, cnt, f, l, day, hour]) => {
        let rowClass = cnt > 0 ? "row-in" : "row-zero";
        resultHtml += `<tr class="${rowClass}"><td>${u}</td><td>${cnt}</td>`;
        if(showFirst) resultHtml += `<td>${f}</td>`;
        if(showLast) resultHtml += `<td>${l}</td>`;
        if(showDay) resultHtml += `<td>${day}</td>`;
        if(showHour) resultHtml += `<td>${hour}</td>`;
        resultHtml += `</tr>`;
      });
      resultHtml += `</table>`;
      document.getElementById('result').innerHTML = resultHtml;
    }

    function getHour(timestr){
      let m = timestr.match(/(ì˜¤ì „|ì˜¤í›„)\s*(\d{1,2}):\d{2}/);
      if(!m) return -1;
      let h = parseInt(m[2]);
      if(m[1]==='ì˜¤í›„' && h<12) h+=12;
      if(m[1]==='ì˜¤ì „' && h===12) h=0;
      return h;
    }
    function getMaxDay(arr, weekNames, enabled){
      if(!enabled||!arr) return "-";
      let max = Math.max(...arr);
      if(max<=0) return "-";
      let idx = arr.indexOf(max);
      return weekNames[idx];
    }
    function getMaxHour(arr, enabled){
      if(!enabled||!arr) return "-";
      let max = Math.max(...arr);
      if(max<=0) return "-";
      let idx = arr.indexOf(max);
      return `${idx}ì‹œ~${idx+1}ì‹œ`;
    }
    function capturePage() {
      let area = document.getElementById('captureArea');
      html2canvas(area, {backgroundColor: '#fff', scale:2, windowWidth: document.body.scrollWidth}).then(function(canvas) {
        let link = document.createElement('a');
        link.download = 'mbti_ëŒ€í™”ë¹ˆë„ë¶„ì„.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
  </script>
</body>
</html>
